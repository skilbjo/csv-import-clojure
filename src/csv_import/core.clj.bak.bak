(ns csv-import.core
  (:require [clojure.java.io :as io]
            [clojure-csv.core :as csv]
            [clojure.java.jdbc :as sql])
  (:gen-class))

(def filepath "./data/direct_mail.promocodes.csv")

(def db {:subprotocol "postgresql"
         :subname "//localhost:5432/direct_mail"
         :user "john.skilbeck"})

(defn insert-db 
  [record]
  (clojure.pprint/pprint record)
  (sql/insert! db
    :promocodes record))    
    

(defn parse-row [row]
  (let [v (first(csv/parse-csv row))]
    (zipmap [:model 
            :datasource 
            (keyword "\"Add Suppresions\"")
            (keyword "\"Selection Strategy Notes\"") 
            (keyword "\"New/Remail\"")
            (keyword "\"Cell Segment\"")
            (keyword "\"Test Description\"")
            (keyword "\"Mail Date\"")
            (keyword "\"Promo Codes\"")
            (keyword "\"Mailed Quantity\"")
            (keyword "\"p_1\"")
            (keyword "\"Actual Mailed Quantity\"")
            ] v)))

(defn read-file [fname]
  (with-open [rdr (io/reader fname)]
    (doseq [line (line-seq rdr)]
      (->
        line
        parse-row
        insert-db))))

(defn -main [& args]
  (->
    filepath
    read-file))

